<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.joonzis.mapper.UserMapper">
	 
	 <resultMap id="userInfoDecoMap" type="org.joonzis.domain.UserInfoDecoDTO">
	    <result column="user_no" property="user_no"/>
	    <result column="user_rank" property="user_rank"/>
	    <result column="user_nick" property="user_nick"/>
	    <result column="boundary_class_name" property="boundary_class_name"/>
	    <result column="title_class_name" property="title_class_name"/>
	    <result column="fontcolor_class_name" property="fontcolor_class_name"/>
	    <result column="background_class_name" property="background_class_name"/>
	    <result column="balloon_class_name" property="balloon_class_name"/>
	</resultMap>

	 <!-- Top 10 유저 랭킹 목록 -->
	<select id="getUserRankingList" resultMap="userInfoDecoMap">
	    <![CDATA[
	        SELECT *
			FROM (
			  SELECT 
			    U.USER_NO AS user_no,
			    U.USER_RANK AS user_rank,
			    U.USER_NICK AS user_nick,
			    COALESCE(D.BOUNDARY_CLASS_NAME, 'default-boundary') AS boundary_class_name,
			    COALESCE(D.TITLE_CLASS_NAME, 'default-title') AS title_class_name,
			    COALESCE(D.FONTCOLOR_CLASS_NAME, 'default-color') AS fontcolor_class_name,
			    COALESCE(D.BACKGROUND_CLASS_NAME, 'default-background') AS background_class_name,
			    COALESCE(D.BALLOON_CLASS_NAME, 'default-balloon') AS balloon_class_name
			  FROM USERS U
			  LEFT JOIN USER_DECO D ON U.USER_NO = D.USER_NO
			  ORDER BY U.USER_RANK DESC
			)
			WHERE ROWNUM <= 10
	    ]]>
	</select>
	
	<!-- 모든 아이템 목록 -->
	<select id="getItemList" resultType="org.joonzis.domain.ItemVO">
		SELECT * FROM ITEMS
	</select>
	<!-- 인벤토리 - 카테고리별 아이템 목록 -->
	<select id="getInventoryCategory" parameterType="map" resultType="org.joonzis.domain.ItemVO">
	    SELECT 
	      i.ITEM_NO          AS item_no,
	      i.ITEM_PRICE       AS item_price,
	      i.ITEM_NAME        AS item_name,
	      i.ITEM_TYPE        AS item_type,
	      i.IMAGE_FILE_NAME  AS imageFileName
	    FROM INVENTORY inv
	    JOIN ITEMS     i
	      ON inv.ITEM_NAME = i.ITEM_NAME
	     AND inv.ITEM_TYPE = i.ITEM_TYPE
	    WHERE inv.USER_NO   = #{user_no}
	      AND inv.ITEM_TYPE = #{category}
  	</select>
	<!-- 보유 아이템 목록 -->
	<select id="getInventory" resultType="org.joonzis.domain.ItemVO">
		SELECT ITEM_NAME
		FROM INVENTORY
		WHERE USER_NO = #{user_no}
	</select>

	<!-- 유저 장식 업데이트 -->
	<update id="updateItem" parameterType="org.joonzis.domain.UserDecoUpdateDTO">
		UPDATE USER_DECO
	    <set>
	      <choose>
	        <when test="itemType == 'boundary'">
	          BOUNDARY_ITEM_NO  = #{itemNo, jdbcType=INTEGER}
	        </when>
	        <when test="itemType == 'title'">
	          TITLE_ITEM_NO     = #{itemNo, jdbcType=INTEGER}
	        </when>
	        <when test="itemType == 'fontColor'">
	          FONTCOLOR_ITEM_NO = #{itemNo, jdbcType=INTEGER}
	        </when>
	        <when test="itemType == 'background'">
	          BACKGROUND_ITEM_NO = #{itemNo, jdbcType=INTEGER}
	        </when>
	        <when test="itemType == 'balloon'">
	          BALLOON_ITEM_NO   = #{itemNo, jdbcType=INTEGER}
	        </when>
	      </choose>
	    </set>
	    WHERE USER_NO = #{userNo}
  </update>
	
	<!-- userNo로 유저 정보+css 찾기	 -->
	<select id="getUserInfoByUserNo" resultType="org.joonzis.domain.UserInfoDecoDTO">
		SELECT *
		FROM users u
		JOIN user_deco d ON u.user_no = d.user_no
		WHERE u.user_no = #{user_no}
	</select>
	
	<!-- 업적 달성 - 포인트 추가 -->
	<update id="updateUserPoint" parameterType="org.joonzis.domain.UserAchievementDTO">
		UPDATE USERS
	    SET USER_POINT = USER_POINT + #{ach_reward}
	    WHERE USER_NO = #{user_no}
	</update>
	
	
	<!-- 아이템 구매 - 포인트 감소 -->
	<update id="userPointMinus">
		UPDATE USERS
		SET USER_POINT = USER_POINT - #{item_price}
		WHERE USER_NO = #{user_no}
	</update>
	<!-- 아이템 구매 - 인벤토리에 추가 -->
	<insert id="buyItemInventory">
		INSERT INTO INVENTORY (USER_NO, CSS_CLASS_NAME, ITEM_NAME, ITEM_TYPE)
		VALUES (#{user_no}, #{css_class_name}, #{item_name}, #{item_type})
	</insert>
	
	<!-- 리워드 상태 -->
	<select id="getRewardStatus" resultType="org.joonzis.domain.UserRewardVO">
		SELECT *
		FROM USER_REWARDS
		WHERE USER_NO = #{user_no}
	</select>
	<!-- 리워드 상태 업데이트 -->
	<update id="rewardUpdate" parameterType="org.joonzis.domain.UserRewardVO">
		UPDATE USER_REWARDS
		SET BOUNDARY = #{boundary},
			TITLE = #{title},
			FONTCOLOR = #{fontColor},
			BACKGROUND = #{background}
		WHERE USER_NO = #{user_no}
	</update>
	<!-- 리워드 보상 획득 -->
	<insert id="addReward" parameterType="org.joonzis.domain.UserDecoUpdateDTO">
		INSERT INTO INVENTORY (USER_NO, CSS_CLASS_NAME, ITEM_NAME, ITEM_TYPE)
		VALUES (#{user_no}, #{css_class_name}, #{item_name}, #{item_type})
	</insert>
	
	<!-- 회원가입 - 닉네임 중복 확인 -->
	<select id="isUserNickTaken" resultType="int" parameterType="String">
		SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
		  FROM USERS
		  WHERE USER_NICK = #{user_nick}
	</select>
	<!-- 회원가입 - 아이디 중복 확인 -->
	<select id="isUserIdTaken" resultType="int" parameterType="String">
		SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
		  FROM USERS
		  WHERE USER_ID = #{user_id}
	</select>
	<!-- 회원가입 - 이메일 중복 확인 -->
	<select id="isUserEmailTaken" resultType="int" parameterType="String">
		SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
		  FROM USERS
		  WHERE USER_EMAIL = #{user_email}
	</select>
	
	<!-- 아이디 찾기 -->
	<select id="findIdByEmail" resultType="String" parameterType="String">
		SELECT USER_ID FROM USERS WHERE USER_EMAIL = #{user_email}
	</select>
	<!-- 비밀번호 찾기 -->
	<select id="findUserByIdAndEmail" resultType="org.joonzis.domain.UserInfoDTO">
		SELECT * FROM USERS WHERE USER_EMAIL = #{user_email} AND USER_ID = #{user_id}
	</select>
	<!-- 비밀번호 찾기 - 비밀번호 변경 -->
	<update id="updatePassword" parameterType="org.joonzis.domain.UserInfoDTO">
		UPDATE USERS
		SET USER_PW = #{user_pw}
		WHERE USER_ID = #{user_id} AND USER_EMAIL = #{user_email}
	</update>
	
	<!-- 유저 닉네임 변경 -->
	<update id="updateNickname">
	    UPDATE USERS
	    SET USER_NICK = #{user_nick}
	    WHERE USER_NO = #{user_no}
	</update>
	
	<!-- 유저프로필이미지선택 -->
	<update id="updateProfileImage" parameterType="map">
	    UPDATE users
	      SET user_profile_img = #{imageUrl}
	    WHERE user_no = #{userNo}
	</update>
	
	<!-- VO용 조회 쿼리 -->
	<select id="getUsersByUserNo" parameterType="int" resultType="org.joonzis.domain.UsersVO">
	    SELECT 
	      user_no,
	      user_id,
	      user_nick,
	      user_email,
	      user_rank,
	      user_point,
	      user_profile_img
	    FROM users
	    WHERE user_no = #{userNo}
	</select>
	
</mapper>